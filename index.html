<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Macé¢¨ãƒ¡ãƒ¢ã‚¢ãƒ—ãƒª</title>
  <link rel="stylesheet" href="sample.css">
</head>
<body>
  <div class="window">
    <div class="window-header">
      <div class="dot red"></div>
      <div class="dot yellow"></div>
      <div class="dot green"></div>
    </div>
    <div class="window-body">
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-title">ãƒ¡ãƒ¢</div>
          <button class="new-note-btn" id="newNoteBtn">ï¼‹ æ–°è¦</button>
        </div>
        <ul class="note-list" id="noteList"></ul>
      </aside>

      <section class="editor">
        <div class="editor-header">
          <input type="text" id="noteTitle" class="editor-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
          <button id="pinNoteBtn" class="icon-btn" title="ãƒ”ãƒ³ç•™ã‚åˆ‡æ›¿">â˜†</button>
          <button id="deleteNoteBtn" class="icon-btn icon-delete" title="ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤">ğŸ—‘</button>
        </div>
        <div class="editor-main">
          <textarea id="noteBody" class="editor-textarea" placeholder="ã“ã“ã«ãƒ¡ãƒ¢ã‚’æ›¸ã„ã¦ãã ã•ã„"></textarea>
        </div>
        <div class="editor-footer" id="statusText">
          ä¿å­˜æ¸ˆã¿
        </div>
      </section>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "mac-like-notes-v1";
    let notes = [];
    let activeNoteId = null;
    let saveTimer = null;

    function loadNotes() {
      const data = localStorage.getItem(STORAGE_KEY);
      notes = data ? JSON.parse(data) : [];
      // å¤ã„ãƒ‡ãƒ¼ã‚¿ã«ã¯ pinned ãŒãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§è£œæ­£
      notes = notes.map(n => ({
        ...n,
        pinned: !!n.pinned
      }));
      sortNotesInPlace();
    }

    function saveNotes() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
    }

    function createNote() {
      const id = Date.now().toString();
      const newNote = {
        id,
        title: "æ–°ã—ã„ãƒ¡ãƒ¢",
        body: "",
        updatedAt: Date.now(),
        pinned: false
      };
      notes.push(newNote);
      sortNotesInPlace();
      activeNoteId = id;
      saveNotes();
      renderNoteList();
      renderEditor();
    }

    function setActiveNote(id) {
      activeNoteId = id;
      renderNoteList();
      renderEditor();
    }

    function getActiveNote() {
      return notes.find(n => n.id === activeNoteId) || null;
    }

    function formatDate(ts) {
      const d = new Date(ts);
      const y = d.getFullYear();
      const m = d.getMonth() + 1;
      const day = d.getDate();
      const h = d.getHours().toString().padStart(2, "0");
      const min = d.getMinutes().toString().padStart(2, "0");
      return `${y}/${m}/${day} ${h}:${min}`;
    }

    function sortNotesInPlace() {
      notes.sort((a, b) => {
        if (a.pinned && !b.pinned) return -1;
        if (!a.pinned && b.pinned) return 1;
        return b.updatedAt - a.updatedAt;
      });
    }

    function renderNoteList() {
      const listEl = document.getElementById("noteList");
      listEl.innerHTML = "";
      notes.forEach(note => {
        const li = document.createElement("li");
        li.className = "note-item" + (note.id === activeNoteId ? " active" : "");
        li.dataset.id = note.id;

        const titleEl = document.createElement("div");
        titleEl.className = "note-item-title";
        titleEl.textContent = (note.pinned ? "ğŸ“Œ " : "") + (note.title || "ï¼ˆç„¡é¡Œï¼‰");

        const previewEl = document.createElement("div");
        previewEl.className = "note-item-preview";
        const previewText = (note.body || "").replace(/\n/g, " ");
        previewEl.textContent = previewText.slice(0, 30);

        const dateEl = document.createElement("div");
        dateEl.className = "note-item-date";
        dateEl.textContent = formatDate(note.updatedAt);

        li.appendChild(titleEl);
        li.appendChild(previewEl);
        li.appendChild(dateEl);

        li.addEventListener("click", () => {
          setActiveNote(note.id);
        });

        listEl.appendChild(li);
      });
    }

    function renderEditor() {
      const titleInput = document.getElementById("noteTitle");
      const bodyTextarea = document.getElementById("noteBody");
      const statusText = document.getElementById("statusText");
      const pinBtn = document.getElementById("pinNoteBtn");

      const note = getActiveNote();
      if (!note) {
        titleInput.value = "";
        bodyTextarea.value = "";
        statusText.textContent = "ãƒ¡ãƒ¢ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“";
        if (pinBtn) {
          pinBtn.disabled = true;
          pinBtn.textContent = "â˜†";
        }
        return;
      }

      titleInput.value = note.title;
      bodyTextarea.value = note.body;
      statusText.textContent = "ä¿å­˜æ¸ˆã¿ï¼š" + formatDate(note.updatedAt);
      if (pinBtn) {
        pinBtn.disabled = false;
        pinBtn.textContent = note.pinned ? "â˜…" : "â˜†";
      }
    }

    function setupEvents() {
      const newBtn = document.getElementById("newNoteBtn");
      const titleInput = document.getElementById("noteTitle");
      const bodyTextarea = document.getElementById("noteBody");
      const statusText = document.getElementById("statusText");
      const deleteBtn = document.getElementById("deleteNoteBtn");
      const pinBtn = document.getElementById("pinNoteBtn");

      newBtn.addEventListener("click", () => {
        createNote();
      });

      if (deleteBtn) {
        deleteBtn.addEventListener("click", () => {
          const note = getActiveNote();
          if (!note) return;
          const ok = window.confirm("ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ");
          if (!ok) return;
          const idx = notes.findIndex(n => n.id === note.id);
          if (idx !== -1) {
            notes.splice(idx, 1);
            if (notes.length > 0) {
              sortNotesInPlace();
              activeNoteId = notes[0].id;
            } else {
              activeNoteId = null;
            }
            saveNotes();
            renderNoteList();
            renderEditor();
          }
        });
      }

      if (pinBtn) {
        pinBtn.addEventListener("click", () => {
          const note = getActiveNote();
          if (!note) return;
          note.pinned = !note.pinned;
          note.updatedAt = Date.now();
          sortNotesInPlace();
          saveNotes();
          renderNoteList();
          renderEditor();
        });
      }

      function scheduleSave() {
        const note = getActiveNote();
        if (!note) return;

        note.title = titleInput.value;
        note.body = bodyTextarea.value;
        note.updatedAt = Date.now();

        statusText.textContent = "ä¿å­˜ä¸­...";

        if (saveTimer) clearTimeout(saveTimer);

        saveTimer = setTimeout(() => {
          sortNotesInPlace();
          saveNotes();
          renderNoteList();
          statusText.textContent = "ä¿å­˜æ¸ˆã¿ï¼š" + formatDate(note.updatedAt);
        }, 500);
      }

      titleInput.addEventListener("input", scheduleSave);
      bodyTextarea.addEventListener("input", scheduleSave);
    }

    function init() {
      loadNotes();
      if (notes.length === 0) {
        createNote();
      } else {
        activeNoteId = notes[0].id;
      }
      renderNoteList();
      renderEditor();
      setupEvents();
    }

    init();
  </script>
</body>
</html>